//
// Created by jie zou on 2021/3/21.
//
#include <gtest/gtest.h>
#include <iostream>

#include "test_function.h"
#include "nonlinear_solver.h"

class CommonVars: public ::testing::Test {
 protected:
  void SetUp() override {
    t.setZero(41);
    y.setZero(41);
    t << -10.0,
        -9.8,-9.6,-9.4,-9.2,-9.0,
        -8.8,-8.6,-8.4,-8.2,-8.0,
        -7.8,-7.6,-7.4,-7.2,-7.0,
        -6.8,-6.6,-6.4,-6.2,-6.0,
        -5.8,-5.6,-5.4,-5.2,-5.0,
        -4.8,-4.6,-4.4,-4.2,-4.0,
        -3.8,-3.6,-3.4,-3.2,-3.0,
        -2.8,-2.6,-2.4,-2.2,-2.0;
    y << -10.3705526272136,
        -8.25459212584876,-8.00823436741298,-4.75760028772196,-3.76414550754917,-3.39691919000118,
        -1.71301956226591,0.0345950384099680,1.95930167086860,2.97387307039857,2.25922616335510,
        4.68892956352124,5.37340589648589,5.05247929744568,6.22001693777761,5.35977267725444,
        6.29862656525255,7.59198305037813,7.58038265911911,8.08420085278581,7.58348139831318,
        6.39148735714838,8.01141061173756,8.12299449551510,7.50684630971555,7.51548026115667,
        7.29688893624984,6.36944603906834,6.63780378035511,5.38230937562313,6.14009217603922,
        4.45844969275484,4.59787796992178,3.77183078126231,3.49915956247170,4.57091565665459,
        3.93020124595163,2.79247096012172,3.68137209767671,1.48114816100582,1.93348871931280;
    x0.setZero(4);
    x0 << 0.5, 0.5, 0.5, 0.5;
  }
  Eigen::VectorXd t, y, x0;

};

TEST_F(CommonVars, QEMTest) {
  std::cout << "L-M Method Testing: " << std::endl;
  std::cout << "Problem states: min fTf = ||y-(a*t^3+b*t^2+c*t+d)||^2." << std::endl;
  TestFunc test_func(&t[0], &y[0], t.size());

  opt::LM_Gauss_Newton lm_gauss_newton(test_func);
  int num_iter = 100;
  lm_gauss_newton.solve(&x0[0], test_func, num_iter);
  std::cout << "Real values: 0.0805069   0.697302 -0.0323877  -0.407608." << std::endl;
  std::cout << "L-M result : " << x0.transpose() << std::endl;


}